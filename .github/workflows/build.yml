name: Build IPA

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Get version info
      id: version
      run: |
        # Extract version from Info.plist or use date-based version
        VERSION=$(date +"%Y.%m.%d")
        BUILD_NUMBER=${{ github.run_number }}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "build=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
        echo "tag=v${VERSION}-${BUILD_NUMBER}" >> $GITHUB_OUTPUT

    - name: Build for iOS Simulator (Debug)
      run: |
        xcodebuild \
          -project NotifyKit.xcodeproj \
          -scheme NotifyKit \
          -sdk iphonesimulator \
          -configuration Debug \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          clean build \
          CODE_SIGNING_ALLOWED=NO

    - name: Build Archive for Device
      run: |
        xcodebuild \
          -project NotifyKit.xcodeproj \
          -scheme NotifyKit \
          -sdk iphoneos \
          -configuration Release \
          -archivePath build/NotifyKit.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          AD_HOC_CODE_SIGNING_ALLOWED=YES

    - name: Create IPA
      id: create_ipa
      run: |
        # Find the .app bundle
        APP_PATH=$(find build/NotifyKit.xcarchive -name "*.app" -type d | head -1)

        if [ -z "$APP_PATH" ]; then
          echo "Error: Could not find .app in archive"
          exit 1
        fi

        echo "Found app at: $APP_PATH"

        # Create Payload structure
        mkdir -p build/Payload
        cp -r "$APP_PATH" build/Payload/

        # Create IPA
        cd build
        zip -r NotifyKit.ipa Payload

        # Get file size
        IPA_SIZE=$(stat -f%z NotifyKit.ipa)
        echo "ipa_size=${IPA_SIZE}" >> $GITHUB_OUTPUT

        rm -rf Payload

    - name: Update apps.json
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # Update the apps.json with new version info
        DATE=$(date +"%Y-%m-%d")
        VERSION="${{ steps.version.outputs.version }}"
        SIZE="${{ steps.create_ipa.outputs.ipa_size }}"

        # Use jq to update the JSON
        jq --arg version "$VERSION" \
           --arg date "$DATE" \
           --argjson size "$SIZE" \
           '.apps[0].versions[0].version = $version |
            .apps[0].versions[0].date = $date |
            .apps[0].versions[0].size = $size' \
           apps.json > apps.json.tmp && mv apps.json.tmp apps.json

        cat apps.json

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: NotifyKit-IPA
        path: build/NotifyKit.ipa
        retention-days: 30

    - name: Create or Update Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Delete existing 'latest' release if it exists
        gh release delete latest --yes || true

        # Delete existing 'latest' tag if it exists
        git push origin :refs/tags/latest || true

        # Create new release
        gh release create latest \
          --title "NotifyKit Latest" \
          --notes "## NotifyKit

        **Version:** ${{ steps.version.outputs.version }}
        **Build:** ${{ steps.version.outputs.build }}

        ### Installation

        **Option 1: Add SideStore/AltStore Source**
        \`\`\`
        https://raw.githubusercontent.com/sbruschke/NotifyKit/main/apps.json
        \`\`\`

        **Option 2: Direct Download**
        Download \`NotifyKit.ipa\` below and sideload with AltStore/SideStore/Sideloadly.

        ### Changes
        - Latest build from main branch" \
          build/NotifyKit.ipa

    - name: Commit updated apps.json
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add apps.json
        git diff --staged --quiet || git commit -m "Update apps.json for version ${{ steps.version.outputs.version }}"
        git push || echo "Nothing to push"
